     1                                  ;************************************************
     2                                  ;   マクロ
     3                                  ;************************************************
     4                                  %include    "../include/define.s"
     1                              <1>     BOOT_LOAD       equ     0x7C00
     2                              <1> 
     3                              <1>     BOOT_SIZE       equ     (1024 * 8)
     4                              <1>     SECT_SIZE       equ     (512)
     5                              <1>     BOOT_SECT       equ     (BOOT_SIZE / SECT_SIZE)
     6                              <1> 
     7                              <1>     E820_RECORD_SIZE    equ     20
     5                                  %include    "../include/macro.s"
     1                              <1> %macro  cdecl 1-*.nolist
     2                              <1> 
     3                              <1>     %rep    %0 - 1
     4                              <1>         push    %{-1:-1}
     5                              <1>         %rotate -1
     6                              <1>     %endrep
     7                              <1>     %rotate - 1
     8                              <1> 
     9                              <1>         call    %1
    10                              <1> 
    11                              <1>     %if 1 < %0
    12                              <1>         add     sp, (__BITS__ >> 3) * (%0 - 1)
    13                              <1>     %endif
    14                              <1> 
    15                              <1> %endmacro
    16                              <1> 
    17                              <1> struc drive
    18 00000000 <res 00000002>      <1>         .no     resw    1           ; ドライブ番号
    19 00000002 <res 00000002>      <1>         .cyln   resw    1           ; シリンダ
    20 00000004 <res 00000002>      <1>         .head   resw    1           ; ヘッド
    21 00000006 <res 00000002>      <1>         .sect   resw    1           ; セクタ
    22                              <1> endstruc
     6                                  
     7                                      ORG     BOOT_LOAD                   ; ロードアドレスをアセンブラに指示
     8                                  
     9                                  ;************************************************
    10                                  ;   エントリポイント
    11                                  ;************************************************
    12                                  entry:
    13                                          ;----------------------------------
    14                                          ;  BPB(BIOS Parameter Block)
    15                                          ;----------------------------------
    16 00000000 EB58                            jmp ipl                             ; IPLへジャンプ
    17 00000002 90<rept>                        times   90 - ($ - $$) db 0x90       ;
    18                                  
    19                                          ;----------------------------------
    20                                          ;  IPL(Intial Program Loader)
    21                                          ;----------------------------------
    22                                  ipl:
    23 0000005A FA                              cli                                 ; // 割り込み禁止
    24                                  
    25 0000005B B80000                          mov     ax, 0x0000                  ; AX = 0x0000;
    26 0000005E 8ED8                            mov     ds, ax                      ; DS = 0x0000;
    27 00000060 8EC0                            mov     es, ax                      ; ES = 0x0000;
    28 00000062 8ED0                            mov     ss, ax                      ; SS = 0x0000;
    29 00000064 BC007C                          mov     sp, BOOT_LOAD               ; SP = 0x7C00;
    30                                  
    31 00000067 FB                              sti                                 ; // 割り込み許可
    32                                  
    33 00000068 8816[B800]                      mov     [BOOT + drive.no], dl       ; ブートドライブを保持
    34                                  
    35                                          ;----------------------------------
    36                                          ;  文字列を表示
    37                                          ;----------------------------------
    38 0000006C 68[9900]E84E0083C4-             cdecl   puts, .s0                   ; puts(.s0)
    38 00000074 02                 
    39                                  
    40                                          ;----------------------------------
    41                                          ;  残りのセクタをすべて読み込む
    42                                          ;----------------------------------
    43 00000075 BB0F00                          mov     bx, BOOT_SECT - 1           ; BX = 残りのブートセクタ数;
    44 00000078 B9007E                          mov     cx, BOOT_LOAD + SECT_SIZE   ; CX = 次のロードアドレス;
    45                                  
    46 0000007B 515368[B800]E89B00-             cdecl   read_chs, BOOT, bx, cx      ; AX = read_chr(.chs, bx, cx);
    46 00000083 83C406             
    47                                  
    48 00000086 39D8                            cmp     ax, bx                      ; if(AX != 残りのセクタ数)
    49 00000088 730C                    .10Q:   jnc     .10E                        ; {
    50 0000008A 68[A600]E8300083C4-     .10T:   cdecl   puts, .e0                   ;    puts(.e0);
    50 00000092 02                 
    51 00000093 E84900                          call    reboot                      ;    reboot();      // 再起動
    52                                  .10E:                                       ; }
    53                                  
    54                                          ;----------------------------------
    55                                          ;  次のステージへ以降
    56                                          ;----------------------------------
    57 00000096 E96305                          jmp     stage_2
    58                                  
    59                                          ;----------------------------------
    60                                          ;  データ
    61                                          ;----------------------------------
    62 00000099 426F6F74696E672E2E-     .s0     db  "Booting...", 0x0A, 0x0D, 0
    62 000000A2 2E0A0D00           
    63 000000A6 4572726F723A736563-     .e0     db  "Error:sector read", 0
    63 000000AF 746F72207265616400 
    64                                  
    65                                  ;************************************************
    66                                  ;   ブートドライブに関する情報
    67                                  ;************************************************
    68                                  ALIGN 2, db 0
    69                                  BOOT:                                           ; ブートドライブに関する情報
    70                                          istruc  drive
    71 000000B8 0000                                at  drive.no,       dw 0            ; ドライブ番号
    72 000000BA 0000                                at  drive.cyln,     dw 0            ; C: シリンダ
    73 000000BC 0000                                at  drive.head,     dw 0            ; H: ヘッド
    74 000000BE 0200                                at  drive.sect,     dw 2            ; S: セクタ
    75                                          iend
    76                                  
    77                                  ;************************************************
    78                                  ;   モジュール
    79                                  ;************************************************
    80                                  %include "../modules/real/puts.s"
     1                              <1> puts:
     2                              <1>     ;---------------------------------
     3                              <1>     ;   スタックフレームの構築
     4                              <1>     ;---------------------------------
     5                              <1>                                         ;   BP+ 4| 文字列へのアドレス
     6 000000C0 55                  <1>     push    bp                          ;   BP+ 2| IP(戻り番地)
     7 000000C1 89E5                <1>     mov     bp, sp                      ;   BP+ 0| BP(元の値)
     8                              <1>                                         ;  ------+------
     9                              <1> 
    10                              <1>     ;---------------------------------
    11                              <1>     ;   レジスタの保存
    12                              <1>     ;---------------------------------
    13 000000C3 50                  <1>     push    ax
    14 000000C4 53                  <1>     push    bx
    15 000000C5 56                  <1>     push    si
    16                              <1> 
    17                              <1>     ;---------------------------------
    18                              <1>     ;   引数の取得
    19                              <1>     ;---------------------------------
    20 000000C6 8B7604              <1>     mov     si, [bp + 4]                ; SI = 文字列へのアドレス;
    21                              <1> 
    22                              <1>     ;---------------------------------
    23                              <1>     ;   処理の開始
    24                              <1>     ;---------------------------------
    25 000000C9 B40E                <1>     mov ah, 0x0E                        ; テレタイプ式1文字出力
    26 000000CB BB0000              <1>     mov bx, 0x0000                      ; ページ番号と文字色を0に設定
    27 000000CE FC                  <1>     cld                                 ; DF = 0; // アドレス加算
    28                              <1> .10L:                                   ; do
    29                              <1>                                         ; {
    30 000000CF AC                  <1>     lodsb                               ;   AL = *SI++;
    31                              <1>                                         ;
    32 000000D0 3C00                <1>     cmp     al, 0                       ;   if(0 == AL);
    33 000000D2 7404                <1>     je      .10E                        ;     break;
    34                              <1>                                         ;
    35 000000D4 CD10                <1>     int     0x10                        ;   Int10(0x0E, AL) // 文字列出力
    36 000000D6 EBF7                <1>     jmp     .10L                        ;
    37                              <1> .10E:                                   ; } while(1);
    38                              <1> 
    39                              <1>     ;---------------------------------
    40                              <1>     ;   レジスタの復帰
    41                              <1>     ;---------------------------------
    42 000000D8 5E                  <1>     pop si
    43 000000D9 5B                  <1>     pop bx
    44 000000DA 58                  <1>     pop ax
    45                              <1> 
    46                              <1>     ;---------------------------------
    47                              <1>     ;   スタックフレームの破棄
    48                              <1>     ;---------------------------------
    49 000000DB 89EC                <1>     mov sp, bp
    50 000000DD 5D                  <1>     pop bp
    51                              <1> 
    52 000000DE C3                  <1>     ret
    81                                  %include "../modules/real/reboot.s"
     1                              <1> reboot:
     2                              <1>         ;------------------------------------
     3                              <1>         ; メッセージを表示
     4                              <1>         ;------------------------------------
     5                              <1> 
     6 000000DF 68[FB00]E8DBFF83C4- <1>         cdecl   puts, .s0
     6 000000E7 02                  <1>
     7                              <1> 
     8                              <1>         ;------------------------------------
     9                              <1>         ; キー入力待ち
    10                              <1>         ;------------------------------------
    11                              <1> .10L:
    12                              <1> 
    13 000000E8 B410                <1>         mov     ah, 0x10
    14 000000EA CD16                <1>         int     0x16
    15                              <1> 
    16 000000EC 3C20                <1>         cmp     al, ' '
    17 000000EE 75F8                <1>         jne     .10L
    18                              <1> 
    19                              <1>         ;------------------------------------
    20                              <1>         ; 開業を出力
    21                              <1>         ;------------------------------------
    22 000000F0 68[1901]E8CAFF83C4- <1>         cdecl   puts, .s1
    22 000000F8 02                  <1>
    23                              <1> 
    24                              <1>         ;------------------------------------
    25                              <1>         ; 再起動
    26                              <1>         ;------------------------------------
    27 000000F9 CD19                <1>         int     0x19
    28                              <1> 
    29                              <1>         ;------------------------------------
    30                              <1>         ; 文字列データ
    31                              <1>         ;------------------------------------
    32 000000FB 0A0D50757368205350- <1> .s0     db  0x0A, 0x0D, "Push SPACE key to reboot...", 0
    32 00000104 414345206B65792074- <1>
    32 0000010D 6F207265626F6F742E- <1>
    32 00000116 2E2E00              <1>
    33 00000119 0A0D0A0D00          <1> .s1     db  0x0A, 0x0D, 0x0A, 0x0D, 0
    82                                  %include "../modules/real/read_chs.s"
     1                              <1> read_chs:
     2                              <1>         ;----------------------------------
     3                              <1>         ; スタックフレームの構築
     4                              <1>         ;----------------------------------
     5                              <1>                                             ;    + 8| コピー先
     6                              <1>                                             ;    + 6| セクタ数
     7                              <1>                                             ;    + 4| パラメータバッファ
     8                              <1>                                             ; ------+--------------
     9                              <1>                                             ;    + 2| IP(戻り番地)
    10 0000011E 55                  <1>         push    bp                          ;  BP+ 0| BP(元の値)
    11 0000011F 89E5                <1>         mov     bp, sp                      ; ------+--------------
    12 00000121 6A03                <1>         push    3                           ;    - 2| retry = 3; // リトライ回数
    13 00000123 6A00                <1>         push    0                           ;    - 4| sect  = 0; // 読み込みセクタ数
    14                              <1> 
    15                              <1>         ;----------------------------------
    16                              <1>         ; レジスタの保存
    17                              <1>         ;----------------------------------
    18 00000125 53                  <1>         push    bx
    19 00000126 51                  <1>         push    cx
    20 00000127 52                  <1>         push    dx
    21 00000128 06                  <1>         push    es
    22 00000129 56                  <1>         push    si
    23                              <1> 
    24                              <1>         ;----------------------------------
    25                              <1>         ; 処理の開始
    26                              <1>         ;----------------------------------
    27 0000012A 8B7604              <1>         mov     si, [bp + 4]
    28                              <1> 
    29                              <1>         ;----------------------------------
    30                              <1>         ; CXレジスタの設定
    31                              <1>         ; (BIOSコールの呼び出しに適した型氏に変換)
    32                              <1>         ;----------------------------------
    33 0000012D 8A6C02              <1>         mov     ch, [si + drive.cyln + 0]
    34 00000130 8A4C03              <1>         mov     cl, [si + drive.cyln + 1]
    35 00000133 C0E106              <1>         shl     cl, 6
    36 00000136 0A4C06              <1>         or      cl, [si + drive.sect]
    37                              <1> 
    38                              <1>         ;----------------------------------
    39                              <1>         ; セクタ読み込み
    40                              <1>         ;----------------------------------
    41 00000139 8A7404              <1>         mov     dh, [si + drive.head]
    42 0000013C 8A14                <1>         mov     dl, [si + 0]
    43 0000013E B80000              <1>         mov     ax, 0x0000
    44 00000141 8EC0                <1>         mov     es, ax
    45 00000143 8B5E08              <1>         mov     bx, [bp + 8]
    46                              <1> .10L:
    47                              <1> 
    48 00000146 B402                <1>         mov     ah, 0x02
    49 00000148 8A4606              <1>         mov     al, [bp + 6]
    50                              <1> 
    51 0000014B CD13                <1>         int     0x13
    52 0000014D 7304                <1>         jnc     .11E
    53                              <1> 
    54 0000014F B000                <1>         mov     al, 0
    55 00000151 EB0C                <1>         jmp     .10E
    56                              <1> .11E:
    57                              <1> 
    58 00000153 3C00                <1>         cmp     al, 0
    59 00000155 7508                <1>         jne     .10E
    60                              <1> 
    61 00000157 B80000              <1>         mov     ax, 0
    62 0000015A FF4EFE              <1>         dec     word [bp - 2]
    63 0000015D 75E7                <1>         jnz     .10L
    64                              <1> .10E:
    65 0000015F B400                <1>         mov     ah, 0
    66                              <1> 
    67                              <1>         ;----------------------------------
    68                              <1>         ; レジスタの復帰
    69                              <1>         ;----------------------------------
    70 00000161 5E                  <1>         pop     si
    71 00000162 07                  <1>         pop     es
    72 00000163 5A                  <1>         pop     dx
    73 00000164 59                  <1>         pop     cx
    74 00000165 5B                  <1>         pop     bx
    75                              <1> 
    76                              <1>         ;----------------------------------
    77                              <1>         ; スタックフレームの破棄
    78                              <1>         ;----------------------------------
    79 00000166 89EC                <1>         mov     sp, bp
    80 00000168 5D                  <1>         pop     bp
    81                              <1> 
    82 00000169 C3                  <1>         ret
    83                                  
    84                                  ;************************************************
    85                                  ;   ブートフラグ(先頭512バイトの終了)
    86                                  ;************************************************
    87 0000016A 00<rept>                    times   510 - ($ - $$) db 0x00
    88 000001FE 55AA                        db  0x55, 0xAA
    89                                  
    90                                  ;************************************************
    91                                  ;   リアルモード時に取得した情報
    92                                  ;************************************************
    93                                  FONT:                                           ; フォント
    94 00000200 0000                    .seg:   dw  0
    95 00000202 0000                    .off:   dw  0
    96                                  ACPI_DATA:                                      ; ACPI data
    97 00000204 00000000                .adr:   dd  0                                   ; ACPI data address
    98 00000208 00000000                .len:   dd  0                                   ; ACPI data length
    99                                  
   100                                  ;************************************************
   101                                  ;   モジュール(先頭512バイト以降に配置)
   102                                  ;************************************************
   103                                  %include "../modules/real/itoa.s"
     1                              <1> itoa:
     2                              <1>         ;------------------------------------------
     3                              <1>         ; スタックフレームの構築
     4                              <1>         ;------------------------------------------
     5                              <1>                                                     ;     +12| BP(元の値)
     6                              <1>                                                     ;     +10| BP(元の値)
     7                              <1>                                                     ;     + 8| BP(元の値)
     8                              <1>                                                     ;     + 6| BP(元の値)
     9                              <1>                                                     ;     + 4| BP(元の値)
    10                              <1>                                                     ;     + 2| IP(戻り番地)
    11 0000020C 55                  <1>         push    bp                                  ;   BP+ 0| BP(元の値)
    12 0000020D 89E5                <1>         mov     bp, sp                              ; -------+-------------
    13                              <1> 
    14                              <1>         ;------------------------------------------
    15                              <1>         ; レジスタの保存
    16                              <1>         ;------------------------------------------
    17 0000020F 50                  <1>         push    ax
    18 00000210 53                  <1>         push    bx
    19 00000211 51                  <1>         push    cx
    20 00000212 52                  <1>         push    dx
    21 00000213 56                  <1>         push    si
    22 00000214 57                  <1>         push    di
    23                              <1> 
    24                              <1>         ;------------------------------------------
    25                              <1>         ; 引数を取得
    26                              <1>         ;------------------------------------------
    27 00000215 8B4604              <1>         mov     ax, [bp + 4]                        ; val   = 数値;
    28 00000218 8B7606              <1>         mov     si, [bp + 6]                        ; dst   = バッファアドレス;
    29 0000021B 8B4E08              <1>         mov     cx, [bp + 8]                        ; size  = 残りバッファサイズ; 
    30                              <1>         
    31 0000021E 89F7                <1>         mov     di, si                              ; // バッファの最後尾
    32 00000220 01CF                <1>         add     di, cx                              ; dst = &dst[size - 1];
    33 00000222 4F                  <1>         dec     di                                  ;
    34                              <1> 
    35 00000223 8B5E0C              <1>         mov     bx, word [bp + 12]                  ; flags = オプション;
    36                              <1> 
    37                              <1>         ;------------------------------------------
    38                              <1>         ; 符号付き判定
    39                              <1>         ;------------------------------------------
    40 00000226 F7C30100            <1>         test    bx, 0b0001                          ; if(flags & 0x01)  // 符号付き
    41 0000022A 7408                <1> .10Q:   je      .10E                                ; {
    42 0000022C 83F800              <1>         cmp     ax, 0                               ;   if(val < 0)
    43 0000022F 7D03                <1> .12Q:   jge     .12E                                ;   {
    44 00000231 83CB02              <1>         or      bx, 0b0010                          ;      flags |= 2;  // 符号表示
    45                              <1> .12E:                                               ;   }
    46                              <1> .10E:                                               ; }
    47                              <1> 
    48                              <1>         ;------------------------------------------
    49                              <1>         ; 符号出力判定
    50                              <1>         ;------------------------------------------
    51 00000234 F7C31A27            <1>         test    bx, 010010                          ; if(flags & 0x02)  // 符号出力判定
    52 00000238 7410                <1> .20Q:   je      .20E                                ; {
    53 0000023A 83F800              <1>         cmp     ax, 0                               ;    if(val < 0)
    54 0000023D 7D07                <1> .22Q:   jge     .22F                                ;    {
    55 0000023F F7D8                <1>         neg     ax                                  ;       val *= -1;  // 符号判定
    56 00000241 C6042D              <1>         mov     [si], byte '-'                      ;       *dst = '-'; // 符号表示
    57 00000244 EB03                <1>         jmp     .22E                                ;    }
    58                              <1> .22F:                                               ;    else
    59                              <1>                                                     ;    {
    60 00000246 C6042B              <1>         mov     [si], byte '+'                      ;       *dst = '+';    // 符号表示
    61                              <1> .22E:                                               ;    }
    62 00000249 49                  <1>         dec     cx                                  ;    size--;           // 残りバッファサイズの減算
    63                              <1> .20E:                                               ; }
    64                              <1> 
    65                              <1>         ;------------------------------------------
    66                              <1>         ; ASCII変換
    67                              <1>         ;------------------------------------------
    68 0000024A 8B5E0A              <1>         mov     bx, [bp + 10]                       ; BX = 基数;
    69                              <1> .30L:                                               ; do
    70                              <1>                                                     ; {
    71 0000024D BA0000              <1>         mov     dx, 0                               ;
    72 00000250 F7F3                <1>         div     bx                                  ;   DX = DX:AX % 基数;
    73                              <1>                                                     ;   AX = DX:AX / 基数;
    74                              <1>                                                     ;
    75 00000252 89D6                <1>         mov     si, dx                              ;   // テーブル参照
    76 00000254 8A94[7C02]          <1>         mov     dl, byte [.ascii + si]              ;   DL = ASCII[DX];
    77                              <1>                                                     ;
    78 00000258 8815                <1>         mov     [di], dl                            ;   *dst = DL;
    79 0000025A 4F                  <1>         dec     di                                  ;   dst--;
    80                              <1>                                                     ;
    81 0000025B 83F800              <1>         cmp     ax, 0                               ;
    82 0000025E E0ED                <1>         loopnz  .30L                                ; } while(AX);
    83                              <1> .30E:
    84                              <1> 
    85                              <1>         ;------------------------------------------
    86                              <1>         ; 空欄を埋める
    87                              <1>         ;------------------------------------------
    88 00000260 83F900              <1>         cmp     cx, 0                               ; if(size)
    89 00000263 740D                <1> .40Q:   je      .40E                                ; {
    90 00000265 B020                <1>         mov     al, ' '                             ;   AL = ' ';   // ' 'で埋める(デフォルト値)
    91 00000267 837E0C04            <1>         cmp     [bp + 12], word 0b0100              ;   if(flags & 0x04)
    92 0000026B 7502                <1> .42Q:   jne     .42E                                ;   {
    93 0000026D B030                <1>         mov     al, '0'                             ;       AL = '0';
    94                              <1> .42E:                                               ;   }
    95 0000026F FD                  <1>         std                                         ;   // DF = 1(-方向)
    96 00000270 F3AA                <1>         rep     stosb                               ;   while(--CX) *DI -- = ' ';
    97                              <1> .40E:                                               ; }
    98                              <1> 
    99                              <1>         ;------------------------------------------
   100                              <1>         ; レジスタの復帰
   101                              <1>         ;------------------------------------------
   102 00000272 5F                  <1>         pop     di
   103 00000273 5E                  <1>         pop     si
   104 00000274 5A                  <1>         pop     dx
   105 00000275 59                  <1>         pop     cx
   106 00000276 5B                  <1>         pop     bx
   107 00000277 58                  <1>         pop     ax
   108                              <1> 
   109                              <1>         ;------------------------------------------
   110                              <1>         ; スタックフレームの破棄
   111                              <1>         ;------------------------------------------
   112 00000278 89EC                <1>         mov     sp, bp
   113 0000027A 5D                  <1>         pop     bp
   114                              <1> 
   115 0000027B C3                  <1>         ret
   116                              <1> 
   117 0000027C 303132333435363738- <1> .ascii  db      "0123456789ABCDEF"                  ; 変換テーブル
   117 00000285 39414243444546      <1>
   104                                  %include "../modules/real/get_drive_param.s"
     1                              <1> get_drive_param:
     2                              <1>         ;----------------------------------
     3                              <1>         ; スタックフレームの構築
     4                              <1>         ;----------------------------------
     5                              <1>                                             ;    + 4| パラメータバッファ
     6                              <1>                                             ;    + 2| IP(戻り番地)
     7 0000028C 55                  <1>         push    bp                          ;  BP+ 0| BP(元の値)
     8 0000028D 89E5                <1>         mov     bp, sp                      ; ------+----------
     9                              <1> 
    10                              <1>         ;----------------------------------
    11                              <1>         ; レジスタの保存
    12                              <1>         ;----------------------------------
    13 0000028F 53                  <1>         push    bx
    14 00000290 51                  <1>         push    cx
    15 00000291 06                  <1>         push    es
    16 00000292 56                  <1>         push    si
    17 00000293 57                  <1>         push    di
    18                              <1> 
    19                              <1>         ;----------------------------------
    20                              <1>         ; 処理の開始
    21                              <1>         ;----------------------------------
    22 00000294 8B7604              <1>         mov     si, [bp + 4]                ; SI = バッファ;
    23                              <1> 
    24 00000297 B80000              <1>         mov     ax, 0                       ; Disk Base Table Pointerの初期化
    25 0000029A 8EC0                <1>         mov     es, ax                      ; ES = 0;
    26 0000029C 89C7                <1>         mov     di, ax                      ; DI = 0;
    27                              <1> 
    28 0000029E B408                <1>         mov     ah, 8                       ; // get drive paramters
    29 000002A0 8A14                <1>         mov     dl, [si + drive.no]         ; DL = ドライブ番号;
    30 000002A2 CD13                <1>         int     0x13                        ; CF = BIOS(0x13, 8);
    31 000002A4 721B                <1> .10Q:   jc      .10F                        ; if(0 == CF)
    32                              <1> .10T:                                       ; {
    33 000002A6 88C8                <1>         mov     al, cl                      ;   AX = セクタ数;
    34 000002A8 83E03F              <1>         and     ax, 0x3F                    ;   // 下位6ビットのみで有効
    35                              <1> 
    36 000002AB C0E906              <1>         shr     cl, 6                       ;   CX = シリンダ数;
    37 000002AE C1C908              <1>         ror     cx, 8                       ;
    38 000002B1 41                  <1>         inc     cx                          ;
    39                              <1> 
    40 000002B2 0FB6DE              <1>         movzx   bx, dh                      ;   BX = ヘッド数(1ベース);
    41 000002B5 43                  <1>         inc     bx                          ;
    42                              <1> 
    43 000002B6 894C02              <1>         mov     [si + drive.cyln], cx       ;   drive.syln = CX;    // C:シリンダ数
    44 000002B9 895C04              <1>         mov     [si + drive.head], bx       ;   drive.head = BX;    // H:ヘッド数
    45 000002BC 894406              <1>         mov     [si + drive.sect], ax       ;   drive.sect = AX;    // S:シリンダ数
    46                              <1> 
    47 000002BF EB03                <1>         jmp     .10E                        ; }
    48                              <1> .10F:                                       ; else
    49                              <1>                                             ; {
    50 000002C1 B80000              <1>         mov     ax, 0                       ;   AX = 0;     // 失敗
    51                              <1> .10E:                                       ; }
    52                              <1> 
    53                              <1>         ;----------------------------------
    54                              <1>         ; レジスタの復帰
    55                              <1>         ;----------------------------------
    56 000002C4 5F                  <1>         pop     di
    57 000002C5 5E                  <1>         pop     si
    58 000002C6 07                  <1>         pop     es
    59 000002C7 59                  <1>         pop     cx
    60 000002C8 5B                  <1>         pop     bx
    61                              <1> 
    62                              <1>         ;----------------------------------
    63                              <1>         ; スタックフレームの破棄
    64                              <1>         ;----------------------------------
    65 000002C9 89EC                <1>         mov     sp, bp
    66 000002CB 5D                  <1>         pop     bp
    67                              <1> 
    68 000002CC C3                  <1>         ret
   105                                  %include "../modules/real/get_font_adr.s"
     1                              <1> get_font_adr:
     2                              <1>         ;----------------------------------
     3                              <1>         ; スタックフレームの構築
     4                              <1>         ;----------------------------------
     5                              <1>                                             ;    + 4| フォントアドレス格納位置
     6                              <1>                                             ;    + 2| IP(戻り番地)
     7 000002CD 55                  <1>         push    bp                          ;  BP+ 0| BP(元の値)
     8 000002CE 89E5                <1>         mov     bp, sp                      ; ------+------------
     9                              <1> 
    10                              <1>         ;----------------------------------
    11                              <1>         ; レジスタの保存
    12                              <1>         ;----------------------------------
    13 000002D0 50                  <1>         push    ax
    14 000002D1 53                  <1>         push    bx
    15 000002D2 56                  <1>         push    si
    16 000002D3 06                  <1>         push    es
    17 000002D4 55                  <1>         push    bp
    18                              <1> 
    19                              <1>         ;----------------------------------
    20                              <1>         ; 引数を取得
    21                              <1>         ;----------------------------------
    22 000002D5 8B7604              <1>         mov     si, [bp + 4]                ; dst = FONTアドレスの保存先;
    23                              <1> 
    24                              <1>         ;----------------------------------
    25                              <1>         ; フォントアドレスの取得
    26                              <1>         ;----------------------------------
    27 000002D8 B83011              <1>         mov     ax, 0x1130                  ; // フォントアドレスの取得
    28 000002DB B706                <1>         mov     bh, 0x06                    ; 8x16 font (vga/mcga)
    29 000002DD CD10                <1>         int     10h                         ; ES:BP = FONT ADDRESS
    30                              <1> 
    31                              <1>         ;----------------------------------
    32                              <1>         ; FONTアドレスを保存
    33                              <1>         ;----------------------------------
    34 000002DF 8C04                <1>         mov     [si + 0], es                ; dst[0] = セグメント;
    35 000002E1 896C02              <1>         mov     [si + 2], bp                ; dst[1] = オフセット;
    36                              <1> 
    37                              <1>         ;----------------------------------
    38                              <1>         ; レジスタの復帰
    39                              <1>         ;----------------------------------
    40 000002E4 5D                  <1>         pop     bp
    41 000002E5 07                  <1>         pop     es
    42 000002E6 5E                  <1>         pop     si
    43 000002E7 5B                  <1>         pop     bx
    44 000002E8 58                  <1>         pop     ax
    45                              <1>         
    46                              <1>         ;----------------------------------
    47                              <1>         ; スタックフレームの破棄
    48                              <1>         ;----------------------------------
    49 000002E9 89EC                <1>         mov     sp, bp
    50 000002EB 5D                  <1>         pop     bp
    51                              <1> 
    52 000002EC C3                  <1>         ret
   106                                  %include "../modules/real/get_mem_info.s"
     1                              <1> get_mem_info:
     2                              <1>         ;----------------------------------
     3                              <1>         ; レジスタの保存
     4                              <1>         ;----------------------------------
     5 000002ED 6650                <1>         push    eax
     6 000002EF 6653                <1>         push    ebx
     7 000002F1 6651                <1>         push    ecx
     8 000002F3 6652                <1>         push    edx
     9 000002F5 56                  <1>         push    si
    10 000002F6 57                  <1>         push    di
    11 000002F7 55                  <1>         push    bp
    12                              <1> 
    13                              <1>         ;----------------------------------
    14                              <1>         ; 処理の開始
    15                              <1>         ;----------------------------------
    16 000002F8 68[8C03]E8C2FD83C4- <1>         cdecl   puts, .s0                   ; // ヘッダを表示
    16 00000300 02                  <1>
    17                              <1> 
    18 00000301 BD0000              <1>         mov     bp, 0                       ; linse = 0;    // 行数
    19 00000304 66BB00000000        <1>         mov     ebx, 0                      ; index = 0;    // インデックスを初期化
    20                              <1> .10L:                                       ; do
    21                              <1>                                             ; {
    22 0000030A 66B820E80000        <1>         mov     eax, 0x0000E820             ;   EAX = 0xE820;
    23                              <1>                                             ;   EBX = インデックス;
    24 00000310 66B914000000        <1>         mov     ecx, E820_RECORD_SIZE       ;   ECX = 要求バイト数;
    25 00000316 66BA50414D53        <1>         mov     edx, 'PAMS'                 ;   EDX = 'SMAP';
    26 0000031C BF[1804]            <1>         mov     di, .b0                     ;   ES:DI = バッファ;
    27 0000031F CD15                <1>         int     0x15                        ;   BIOS(0x15, 0xE820);
    28                              <1> 
    29                              <1>         ; コマンドに対応か?
    30 00000321 663D50414D53        <1>         cmp     eax, 'PAMS'                 ;   if('SMAP' != EAX)
    31 00000327 7402                <1>         je      .12E                        ;   {
    32 00000329 EB4C                <1>         jmp     .10E                        ;     break;    // コマンド未対応
    33                              <1> .12E:                                       ;   }
    34                              <1> 
    35                              <1>         ; エラーなし?                        ;   if(CF)
    36 0000032B 7302                <1>         jnc     .14E                        ;   {
    37 0000032D EB48                <1>         jmp     .10E                        ;     break;    // エラー発生
    38                              <1> .14E:                                       ;   }
    39                              <1> 
    40                              <1>         ; 1レコード分のメモリ情報を表示
    41 0000032F 57E8F90083C402      <1>         cdecl   put_mem_info, di            ;   1レコード分のメモリ情報を表示   
    42                              <1> 
    43                              <1>         ; ACPI dataのアドレスを取得
    44 00000336 668B4510            <1>         mov     eax, [di + 16]              ;   EAX = レコードタイプ;
    45 0000033A 6683F803            <1>         cmp     eax, 3                      ;   if(3 == EAX)  // ACPI data
    46 0000033E 750F                <1>         jne     .15E                        ;   {
    47                              <1>                                             ;
    48 00000340 668B05              <1>         mov     eax, [di + 0]               ;      EAX = BASEアドレス;
    49 00000343 66A3[0402]          <1>         mov     [ACPI_DATA.adr], eax        ;      ACPI_DATA.adr = EAX;
    50                              <1>                                             ;
    51 00000347 668B4508            <1>         mov     eax, [di + 8]               ;      EAX = Length;
    52 0000034B 66A3[0802]          <1>         mov     [ACPI_DATA.len], eax        ;      ACPI_DATA.len = EAX;
    53                              <1> .15E:                                       ;   }
    54                              <1> 
    55 0000034F 6683FB00            <1>         cmp     ebx, 0                      ;   if(0 != EBX)
    56 00000353 741C                <1>         jz      .16E                        ;   {
    57                              <1>                                             ;
    58 00000355 45                  <1>         inc     bp                          ;     lines++;
    59 00000356 83E507              <1>         and     bp, 0x07                    ;     lines &= 0x07;
    60 00000359 7516                <1>         jnz     .16E                        ;     if(0 == lines)
    61                              <1>                                             ;     {
    62 0000035B 68[FF03]E85FFD83C4- <1>         cdecl   puts, .s2                   ;       // 中断メッセージを表示
    62 00000363 02                  <1>
    63 00000364 B410                <1>         mov     ah, 0x10                    ;
    64 00000366 CD16                <1>         int     0x16                        ;       // キー入力待ち
    65                              <1>                                             ;
    66 00000368 68[0A04]E852FD83C4- <1>         cdecl   puts, .s3                   ;       // 中断メッセージを消去
    66 00000370 02                  <1>
    67                              <1>                                             ;     }
    68                              <1> .16E:                                       ;    }
    69                              <1>                                             ;
    70 00000371 6683FB00            <1>         cmp     ebx, 0                      ;
    71 00000375 7593                <1>         jne     .10L                        ; }
    72                              <1> .10E:                                       ; while(0 == EBX);
    73                              <1> 
    74 00000377 68[CF03]E843FD83C4- <1>         cdecl   puts, .s1                   ; // フッタを表示
    74 0000037F 02                  <1>
    75                              <1> 
    76                              <1>         ;----------------------------------
    77                              <1>         ; レジスタの復帰
    78                              <1>         ;----------------------------------
    79 00000380 5D                  <1>         pop     bp
    80 00000381 5F                  <1>         pop     di
    81 00000382 5E                  <1>         pop     si
    82 00000383 665A                <1>         pop     edx
    83 00000385 6659                <1>         pop     ecx
    84 00000387 665B                <1>         pop     ebx
    85 00000389 6658                <1>         pop     eax
    86                              <1> 
    87 0000038B C3                  <1>         ret
    88                              <1> 
    89 0000038C 2045383230204D656D- <1> .s0:    db  " E820 Memory Map:", 0x0A, 0x0D
    89 00000395 6F7279204D61703A0A- <1>
    89 0000039E 0D                  <1>
    90 0000039F 20426173655F5F5F5F- <1>         db  " Base_____________ Length___________ Type____", 0x0A, 0x0D, 0
    90 000003A8 5F5F5F5F5F5F5F5F5F- <1>
    90 000003B1 204C656E6774685F5F- <1>
    90 000003BA 5F5F5F5F5F5F5F5F5F- <1>
    90 000003C3 20547970655F5F5F5F- <1>
    90 000003CC 0A0D00              <1>
    91 000003CF 202D2D2D2D2D2D2D2D- <1> .s1:	db " ----------------- ----------------- --------", 0x0A, 0x0D, 0
    91 000003D8 2D2D2D2D2D2D2D2D2D- <1>
    91 000003E1 202D2D2D2D2D2D2D2D- <1>
    91 000003EA 2D2D2D2D2D2D2D2D2D- <1>
    91 000003F3 202D2D2D2D2D2D2D2D- <1>
    91 000003FC 0A0D00              <1>
    92 000003FF 203C6D6F72652E2E2E- <1> .s2:    db  " <more...>", 0
    92 00000408 3E00                <1>
    93 0000040A 0D2020202020202020- <1> .s3:    db  0x0D, "          ", 0x0D, 0
    93 00000413 20200D00            <1>
    94                              <1> 
    95 00000417 00                  <1> ALIGN 4, db 0
    96 00000418 00<rept>            <1> .b0:    times E820_RECORD_SIZE db 0
    97                              <1> 
    98                              <1> put_mem_info:
    99                              <1>         ;----------------------------------
   100                              <1>         ; スタックフレームの構築
   101                              <1>         ;----------------------------------
   102                              <1>                                             ;      4| バッファアドレス
   103                              <1>                                             ;      2| IP(戻り番地)
   104 0000042C 55                  <1>         push    bp                          ;  BP+ 0| BP(元の値)
   105 0000042D 89E5                <1>         mov     bp, sp                      ;-------+--------
   106                              <1> 
   107                              <1>         ;----------------------------------
   108                              <1>         ; レジスタの保存
   109                              <1>         ;----------------------------------
   110 0000042F 53                  <1>         push    bx
   111 00000430 56                  <1>         push    si
   112                              <1> 
   113                              <1>         ;----------------------------------
   114                              <1>         ; 引数を取得
   115                              <1>         ;----------------------------------
   116 00000431 8B7604              <1>         mov     si, [bp + 4]                ; SI = バッファアドレス;
   117                              <1> 
   118                              <1>         ;----------------------------------
   119                              <1>         ; レコードの表示
   120                              <1>         ;----------------------------------
   121                              <1> 
   122                              <1>         ; Base(64bit)
   123 00000434 6A046A106A0468-     <1>         cdecl   itoa, word [si + 6], .p2 + 0, 4, 16, 0b0100
   123 0000043B [0B05]FF7406E8C9FD- <1>
   123 00000443 83C40A              <1>
   124 00000446 6A046A106A0468-     <1>         cdecl   itoa, word [si + 4], .p2 + 4, 4, 16, 0b0100
   124 0000044D [0F05]FF7404E8B7FD- <1>
   124 00000455 83C40A              <1>
   125 00000458 6A046A106A0468-     <1>         cdecl   itoa, word [si + 2], .p3 + 0, 4, 16, 0b0100
   125 0000045F [1405]FF7402E8A5FD- <1>
   125 00000467 83C40A              <1>
   126 0000046A 6A046A106A0468-     <1>         cdecl   itoa, word [si + 0], .p3 + 4, 4, 16, 0b0100
   126 00000471 [1805]FF34E894FD83- <1>
   126 00000479 C40A                <1>
   127                              <1> 
   128                              <1>         ; Length(64bit)
   129 0000047B 6A046A106A0468-     <1>         cdecl   itoa, word [si + 14], .p4 + 0, 4, 16, 0b0100
   129 00000482 [1D05]FF740EE882FD- <1>
   129 0000048A 83C40A              <1>
   130 0000048D 6A046A106A0468-     <1>         cdecl   itoa, word [si + 12], .p4 + 4, 4, 16, 0b0100
   130 00000494 [2105]FF740CE870FD- <1>
   130 0000049C 83C40A              <1>
   131 0000049F 6A046A106A0468-     <1>         cdecl   itoa, word [si + 10], .p5 + 0, 4, 16, 0b0100
   131 000004A6 [2605]FF740AE85EFD- <1>
   131 000004AE 83C40A              <1>
   132 000004B1 6A046A106A0468-     <1>         cdecl   itoa, word [si +  8], .p5 + 4, 4, 16, 0b0100
   132 000004B8 [2A05]FF7408E84CFD- <1>
   132 000004C0 83C40A              <1>
   133                              <1> 
   134                              <1>         ; Type(64bit)
   135 000004C3 6A046A106A0468-     <1>         cdecl   itoa, word [si + 18], .p6 + 0, 4, 16, 0b0100
   135 000004CA [2F05]FF7412E83AFD- <1>
   135 000004D2 83C40A              <1>
   136 000004D5 6A046A106A0468-     <1>         cdecl   itoa, word [si + 16], .p6 + 4, 4, 16, 0b0100
   136 000004DC [3305]FF7410E828FD- <1>
   136 000004E4 83C40A              <1>
   137                              <1> 
   138 000004E7 68[0A05]E8D3FB83C4- <1>         cdecl   puts, .s1                           ;   // レコード情報を表示
   138 000004EF 02                  <1>
   139                              <1> 
   140 000004F0 8B5C10              <1>         mov     bx, [si + 16]                       ;   // タイプを文字列で表示
   141 000004F3 83E307              <1>         and     bx, 0x07                            ;   BX = Type(0~5)
   142 000004F6 D1E3                <1>         shl     bx, 1                               ;   BX *= 2;    // 要素サイズに変換
   143 000004F8 81C3[8C05]          <1>         add     bx, .t0                             ;   BX += .t0;  // テーブルの先頭アドレスを加算
   144 000004FC FF37E8BFFB83C402    <1>         cdecl   puts, word [bx]                     ;   puts(*BX);
   145                              <1> 
   146                              <1> 
   147                              <1> 
   148                              <1>         ;----------------------------------
   149                              <1>         ; レジスタの復帰
   150                              <1>         ;----------------------------------
   151 00000504 5E                  <1>         pop     si
   152 00000505 5B                  <1>         pop     bx
   153                              <1> 
   154                              <1>         ;----------------------------------
   155                              <1>         ; スタックフレームの破棄
   156                              <1>         ;----------------------------------
   157 00000506 89EC                <1>         mov     sp, bp
   158 00000508 5D                  <1>         pop     bp
   159                              <1> 
   160 00000509 C3                  <1>         ret
   161                              <1> 
   162 0000050A 20                  <1> .s1:    db  " "
   163 0000050B 5A5A5A5A5A5A5A5A5F  <1> .p2:    db  "ZZZZZZZZ_"
   164 00000514 5A5A5A5A5A5A5A5A5F  <1> .p3:    db  "ZZZZZZZZ_"
   165 0000051D 5A5A5A5A5A5A5A5A5F  <1> .p4:    db  "ZZZZZZZZ_"
   166 00000526 5A5A5A5A5A5A5A5A20  <1> .p5:    db  "ZZZZZZZZ "
   167 0000052F 5A5A5A5A5A5A5A5A00  <1> .p6:    db  "ZZZZZZZZ", 0
   168                              <1> 
   169 00000538 2028556E6B6E6F776E- <1> .s4:    db  " (Unknown)", 0x0A, 0x0D, 0
   169 00000541 290A0D00            <1>
   170 00000545 2028757361626C6529- <1> .s5:    db  " (usable)", 0x0A, 0x0D, 0
   170 0000054E 0A0D00              <1>
   171 00000551 202872657365727665- <1> .s6:    db  " (reserved)", 0x0A, 0x0D, 0
   171 0000055A 64290A0D00          <1>
   172 0000055F 202841435049206461- <1> .s7:    db  " (ACPI data)", 0x0A, 0x0D, 0
   172 00000568 7461290A0D00        <1>
   173 0000056E 202841435049204E56- <1> .s8:    db  " (ACPI NVS)", 0x0A, 0x0D, 0
   173 00000577 53290A0D00          <1>
   174 0000057C 2028626164206D656D- <1> .s9:    db  " (bad memory)", 0x0A, 0x0D, 0
   174 00000585 6F7279290A0D00      <1>
   175                              <1> 
   176 0000058C [3805][4505][5105]- <1> .t0:    dw .s4, .s5, .s6, .s7, .s8, .s9, .s4, .s4
   176 00000592 [5F05][6E05][7C05]- <1>
   176 00000598 [3805][3805]        <1>
   107                                  %include "../modules/real/kbc.s"
     1                              <1> KBC_Data_Write:
     2                              <1>         ;------------------------------------------
     3                              <1>         ; スタックフレームの構築
     4                              <1>         ;------------------------------------------
     5                              <1>                                                     ;   + 4| データ
     6                              <1>                                                     ;   + 2| IP(戻り番地)
     7 0000059C 55                  <1>         push    bp                                  ; BP+ 0| BP(元の値)
     8 0000059D 89E5                <1>         mov     bp, sp                              ; -----+------------ 
     9                              <1> 
    10                              <1>         ;------------------------------------------
    11                              <1>         ; レジスタの保存
    12                              <1>         ;------------------------------------------
    13 0000059F 51                  <1>         push    cx
    14                              <1> 
    15 000005A0 B90000              <1>         mov     cx, 0                               ; CX = 0;   // 最大カウント数
    16                              <1> .10L:                                               ; do
    17                              <1>                                                     ; {
    18 000005A3 E464                <1>         in      al, 0x64                            ; AL = inp(0x64);   // KBCステータス
    19 000005A5 A802                <1>         test    al, 0x02                            ; ZF = AL & 0x02;   // 書き込み可能?
    20 000005A7 E0FA                <1>         loopnz  .10L                                ; } while(--CX && !ZF);
    21                              <1> 
    22 000005A9 83F900              <1>         cmp     cx, 0                               ; if(CX)    // 未タイムアウト
    23 000005AC 7405                <1>         jz      .20E                                ; {
    24                              <1>                                                     ;
    25 000005AE 8A4604              <1>         mov     al, [bp + 4]                        ;   AL = データ;
    26 000005B1 E660                <1>         out     0x60, al                            ;   outp(0x60, AL);
    27                              <1> .20E:                                               ; }
    28                              <1> 
    29 000005B3 89C8                <1>         mov     ax, cx                              ; return CX;
    30                              <1> 
    31                              <1>         ;------------------------------------------
    32                              <1>         ; レジスタの復帰
    33                              <1>         ;------------------------------------------
    34 000005B5 59                  <1>         pop     cx
    35                              <1> 
    36                              <1>         ;------------------------------------------
    37                              <1>         ; スタックフレームの破棄
    38                              <1>         ;------------------------------------------
    39 000005B6 89EC                <1>         mov     sp, bp
    40 000005B8 5D                  <1>         pop     bp
    41                              <1> 
    42 000005B9 C3                  <1>         ret
    43                              <1> 
    44                              <1> KBC_Data_Read:
    45                              <1>         ;------------------------------------------
    46                              <1>         ; スタックフレームの構築
    47                              <1>         ;------------------------------------------
    48                              <1>                                                     ;   + 4| データ
    49                              <1>                                                     ;   + 2| IP(戻り番地)
    50 000005BA 55                  <1>         push    bp                                  ; BP+ 0| BP(元の値)
    51 000005BB 89E5                <1>         mov     bp, sp                              ; -----+------------ 
    52                              <1> 
    53                              <1>         ;------------------------------------------
    54                              <1>         ; レジスタの保存
    55                              <1>         ;------------------------------------------
    56 000005BD 51                  <1>         push    cx
    57 000005BE 57                  <1>         push    di
    58                              <1> 
    59 000005BF B90000              <1>         mov     cx, 0                               ; CX = 0;   // 最大カウント数
    60                              <1> .10L:                                               ; do
    61                              <1>                                                     ; {
    62 000005C2 E464                <1>         in      al, 0x64                            ; AL = inp(0x64);   // KBCステータス
    63 000005C4 A801                <1>         test    al, 0x01                            ; ZF = AL & 0x01;   // 読み込み可能?
    64 000005C6 E1FA                <1>         loopz   .10L                                ; } while(--CX && !ZF);
    65                              <1> 
    66 000005C8 83F900              <1>         cmp     cx, 0                               ; if(CX)    // 未タイムアウト
    67 000005CB 7409                <1>         jz      .20E                                ; {
    68                              <1>                                                     ;
    69 000005CD B400                <1>         mov     ah, 0x00                            ;   AH = 0x00;
    70 000005CF E460                <1>         in      al, 0x60                            ;   AL = inp(0x60); // データ取得
    71                              <1> 
    72 000005D1 8B7E04              <1>         mov     di, [bp + 4]                        ;   DI = ptr;
    73 000005D4 8905                <1>         mov     [di + 0], ax                        ;   DI[0] = AX;
    74                              <1> .20E:                                               ; }
    75                              <1> 
    76 000005D6 89C8                <1>         mov     ax, cx                              ; return CX;
    77                              <1> 
    78                              <1>         ;------------------------------------------
    79                              <1>         ; レジスタの復帰
    80                              <1>         ;------------------------------------------
    81 000005D8 5F                  <1>         pop     di
    82 000005D9 59                  <1>         pop     cx
    83                              <1> 
    84                              <1>         ;------------------------------------------
    85                              <1>         ; スタックフレームの破棄
    86                              <1>         ;------------------------------------------
    87 000005DA 89EC                <1>         mov     sp, bp
    88 000005DC 5D                  <1>         pop     bp
    89                              <1> 
    90 000005DD C3                  <1>         ret
    91                              <1> 
    92                              <1> KBC_Cmd_Write:
    93                              <1>         ;------------------------------------------
    94                              <1>         ; スタックフレームの構築
    95                              <1>         ;------------------------------------------
    96                              <1>                                                     ;   + 4| データ
    97                              <1>                                                     ;   + 2| IP(戻り番地)
    98 000005DE 55                  <1>         push    bp                                  ; BP+ 0| BP(元の値)
    99 000005DF 89E5                <1>         mov     bp, sp                              ; -----+------------ 
   100                              <1> 
   101                              <1>         ;------------------------------------------
   102                              <1>         ; レジスタの保存
   103                              <1>         ;------------------------------------------
   104 000005E1 51                  <1>         push    cx
   105                              <1> 
   106 000005E2 B90000              <1>         mov     cx, 0                               ; CX = 0;   // 最大カウント数
   107                              <1> .10L:                                               ; do
   108                              <1>                                                     ; {
   109 000005E5 E464                <1>         in      al, 0x64                            ; AL = inp(0x64);   // KBCステータス
   110 000005E7 A802                <1>         test    al, 0x02                            ; ZF = AL & 0x02;   // 書き込み可能?
   111 000005E9 E0FA                <1>         loopnz  .10L                                ; } while(--CX && !ZF);
   112                              <1> 
   113 000005EB 83F900              <1>         cmp     cx, 0                               ; if(CX)    // 未タイムアウト
   114 000005EE 7405                <1>         jz      .20E                                ; {
   115                              <1>                                                     ;
   116 000005F0 8A4604              <1>         mov     al, [bp + 4]                        ;   AL = データ;
   117 000005F3 E664                <1>         out     0x64, al                            ;   outp(0x64, AL);
   118                              <1> .20E:                                               ; }
   119                              <1> 
   120 000005F5 89C8                <1>         mov     ax, cx                              ; return CX;
   121                              <1> 
   122                              <1>         ;------------------------------------------
   123                              <1>         ; レジスタの復帰
   124                              <1>         ;------------------------------------------
   125 000005F7 59                  <1>         pop     cx
   126                              <1> 
   127                              <1>         ;------------------------------------------
   128                              <1>         ; スタックフレームの破棄
   129                              <1>         ;------------------------------------------
   130 000005F8 89EC                <1>         mov     sp, bp
   131 000005FA 5D                  <1>         pop     bp
   132                              <1> 
   133 000005FB C3                  <1>         ret
   108                                  
   109                                  ;************************************************
   110                                  ;   ブート処理の第2ステージ
   111                                  ;************************************************
   112                                  stage_2:
   113                                          ;----------------------------------
   114                                          ;  文字列を表示
   115                                          ;----------------------------------
   116 000005FC 68[7606]E8BEFA83C4-             cdecl   puts, .s0                       ; puts(.s0);
   116 00000604 02                 
   117                                          
   118                                          ;----------------------------------
   119                                          ;  ドライブ情報を取得
   120                                          ;----------------------------------
   121 00000605 68[B800]E881FC83C4-             cdecl   get_drive_param, BOOT           ; get_drive_param(DX, BOOT.CYLN);
   121 0000060D 02                 
   122 0000060E 83F800                          cmp     ax, 0                           ; if(0 == AX)
   123 00000611 750C                    .10Q:   jne     .10E                            ; {
   124 00000613 68[AD06]E8A7FA83C4-     .10T:   cdecl   puts, .e0                       ;   puts(.e0);
   124 0000061B 02                 
   125 0000061C E8C0FA                          call    reboot                          ;   reboot();   // 再起動
   126                                  .10E:                                           ; }
   127                                          
   128                                          ;----------------------------------
   129                                          ;  ドライブ情報を表示
   130                                          ;----------------------------------
   131 0000061F A1[B800]                        mov     ax, [BOOT + drive.no]           ; AX = ブートドライブ;
   132 00000622 6A046A106A0268-                 cdecl   itoa, ax, .p1, 2, 16, 0b0100    ;
   132 00000629 [8E06]50E8DDFB83C4-
   132 00000631 0A                 
   133 00000632 A1[BA00]                        mov     ax, [BOOT + drive.cyln]         ;
   134 00000635 6A046A106A0468-                 cdecl   itoa, ax, .p2, 4, 16, 0b0100    ;
   134 0000063C [9606]50E8CAFB83C4-
   134 00000644 0A                 
   135 00000645 A1[BC00]                        mov     ax, [BOOT + drive.head]         ; AX = ヘッド数;
   136 00000648 6A046A106A0268-                 cdecl   itoa, ax, .p3, 2, 16, 0b0100    ;
   136 0000064F [A006]50E8B7FB83C4-
   136 00000657 0A                 
   137 00000658 A1[BE00]                        mov     ax, [BOOT + drive.sect]         ; AX = トラック当たりのセクタ数;
   138 0000065B 6A046A106A0268-                 cdecl   itoa, ax, .p4, 2, 16, 0b0100    ;
   138 00000662 [A806]50E8A4FB83C4-
   138 0000066A 0A                 
   139 0000066B 68[8506]E84FFA83C4-             cdecl   puts, .s1
   139 00000673 02                 
   140                                  
   141                                          ;----------------------------------
   142                                          ;  次のステージへ以降
   143                                          ;----------------------------------
   144 00000674 EB52                            jmp     stage_3                         ; 次のステージへ以降
   145                                  
   146                                          ;----------------------------------
   147                                          ;  データ
   148                                          ;----------------------------------
   149 00000676 326E64207374656765-     .s0     db  "2nd stege...", 0x0A, 0x0D, 0
   149 0000067F 2E2E2E0A0D00       
   150                                  
   151 00000685 2044726976653A3078      .s1     db  " Drive:0x"
   152 0000068E 20202C20433A3078        .p1     db  "  , C:0x"
   153 00000696 202020202C20483A30-     .p2     db  "    , H:0x"
   153 0000069F 78                 
   154 000006A0 20202C20533A3078        .p3     db  "  , S:0x"
   155 000006A8 20200A0D00              .p4     db  "  ", 0x0A, 0x0D, 0
   156                                  
   157 000006AD 43616E277420676574-     .e0     db  "Can't get drive parameter.", 0
   157 000006B6 206472697665207061-
   157 000006BF 72616D657465722E00 
   158                                  
   159                                  ;************************************************
   160                                  ;   ブート処理の第3ステージ
   161                                  ;************************************************
   162                                  stage_3:
   163                                          ;----------------------------------
   164                                          ; 文字列を表示
   165                                          ;----------------------------------
   166 000006C8 68[4507]E8F2F983C4-             cdecl   puts, .s0
   166 000006D0 02                 
   167                                  
   168                                          ;----------------------------------
   169                                          ; プロテクトモードで使用するフォントは
   170                                          ; BIOSに内蔵されたものを流用する
   171                                          ;----------------------------------
   172 000006D1 68[0002]E8F6FB83C4-             cdecl   get_font_adr, FONT              ; // BIOSのを取得
   172 000006D9 02                 
   173                                  
   174                                          ;----------------------------------
   175                                          ; フォントアドレスの表示
   176                                          ;----------------------------------
   177 000006DA 6A046A106A0468-                 cdecl   itoa, word [FONT.seg], .p1, 4, 16, 0b0100
   177 000006E1 [6107]FF36[0002]E8-
   177 000006E8 22FB83C40A         
   178 000006ED 6A046A106A0468-                 cdecl   itoa, word [FONT.off], .p2, 4, 16, 0b0100
   178 000006F4 [6607]FF36[0202]E8-
   178 000006FB 0FFB83C40A         
   179 00000700 68[5407]E8BAF983C4-             cdecl   puts, .s1
   179 00000708 02                 
   180                                  
   181                                          ;----------------------------------
   182                                          ;  メモリ情報の取得と表示
   183                                          ;----------------------------------
   184 00000709 E8E1FB                          cdecl   get_mem_info                    ; get_mem_info();
   185                                  
   186 0000070C 66A1[0402]                      mov     eax, [ACPI_DATA.adr]            ; EAX = ACPI_DATA.adr;
   187 00000710 6683F800                        cmp     eax, 0                          ; if(EAX)
   188 00000714 742D                            je      .10E                            ; {
   189                                  
   190 00000716 6A046A106A0468-                 cdecl   itoa, ax, .p4, 4, 16, 0b0100    ;    itoa(AX);  // 下位アドレスを変換
   190 0000071D [7F07]50E8E9FA83C4-
   190 00000725 0A                 
   191 00000726 66C1E810                        shr     eax, 16                         ;    EAX >>= 16;
   192 0000072A 6A046A106A0468-                 cdecl   itoa, ax, .p3, 4, 16, 0b0100    ;    itoa(AX);  // 上位アドレスを変換
   192 00000731 [7B07]50E8D5FA83C4-
   192 00000739 0A                 
   193                                  
   194 0000073A 68[7007]E880F983C4-             cdecl   puts, .s2                       ;    puts(.s2); // アドレスを表示
   194 00000742 02                 
   195                                  .10E:                                           ; }
   196                                  
   197                                          ;----------------------------------
   198                                          ;  次のステージへ以降
   199                                          ;----------------------------------
   200 00000743 EB41                            jmp     stage_4                         ; 次のステージへ以降
   201                                  
   202                                          ;----------------------------------
   203                                          ;  データ
   204                                          ;----------------------------------
   205 00000745 337264207374616765-     .s0:    db  "3rd stage...", 0x0A, 0x0D, 0
   205 0000074E 2E2E2E0A0D00       
   206                                  
   207 00000754 466F6E742041646472-     .s1:    db  "Font Address="
   207 0000075D 6573733D           
   208 00000761 5A5A5A5A3A              .p1:    db  "ZZZZ:"
   209 00000766 5A5A5A5A0A0D00          .p2:    db  "ZZZZ", 0x0A, 0x0D, 0
   210 0000076D 0A0D00                          db  0x0A, 0x0D, 0
   211                                  
   212 00000770 204143504920646174-     .s2:    db  " ACPI data="
   212 00000779 613D               
   213 0000077B 5A5A5A5A                .p3:    db  "ZZZZ"
   214 0000077F 5A5A5A5A0A0D00          .p4:    db  "ZZZZ", 0x0A, 0x0D, 0
   215                                  
   216                                  ;************************************************
   217                                  ;   ブート処理の第4ステージ
   218                                  ;************************************************
   219                                  stage_4:
   220                                          ;----------------------------------
   221                                          ; 文字列を表示
   222                                          ;----------------------------------
   223 00000786 68[D707]E834F983C4-             cdecl   puts, .s0
   223 0000078E 02                 
   224                                  
   225                                          ;----------------------------------
   226                                          ; A20ゲートの有効化
   227                                          ;----------------------------------
   228 0000078F FA                              cli
   229                                  
   230 00000790 68AD00E848FE83C402              cdecl   KBC_Cmd_Write, 0xAD
   231                                  
   232 00000799 68D000E83FFE83C402              cdecl   KBC_Cmd_Write, 0xD0
   233 000007A2 68[FB07]E812FE83C4-             cdecl   KBC_Data_Read, .key
   233 000007AA 02                 
   234                                  
   235 000007AB 8A1E[FB07]                      mov     bl, [.key]
   236 000007AF 80CB02                          or      bl, 0x02
   237                                  
   238 000007B2 68D100E826FE83C402              cdecl   KBC_Cmd_Write, 0xD1
   239 000007BB 53E8DDFD83C402                  cdecl   KBC_Data_Write, bx
   240                                  
   241 000007C2 68AE00E816FE83C402              cdecl   KBC_Cmd_Write, 0xAE
   242                                  
   243 000007CB FB                              sti
   244                                          
   245                                          ;----------------------------------
   246                                          ; 文字列を表示
   247                                          ;----------------------------------
   248 000007CC 68[E607]E8EEF883C4-             cdecl   puts, .s1
   248 000007D4 02                 
   249                                          
   250                                          ;----------------------------------
   251                                          ; 処理の終了
   252                                          ;----------------------------------
   253 000007D5 EBFE                            jmp     $                               ; while(1);     // 無限ループ
   254                                  
   255 000007D7 347468207374616765-     .s0:    db  "4th stage...", 0x0A, 0x0D, 0
   255 000007E0 2E2E2E0A0D00       
   256 000007E6 204132302047617465-     .s1:    db  " A20 Gate Enabled.", 0x0A, 0x0D, 0
   256 000007EF 20456E61626C65642E-
   256 000007F8 0A0D00             
   257                                  
   258 000007FB 0000                    .key:   dw  0
   259                                  
   260                                  ;************************************************
   261                                  ;   パディング
   262                                  ;************************************************
   263 000007FD 00<rept>                        times BOOT_SIZE - ($ - $$)     db  0   ; パディング
